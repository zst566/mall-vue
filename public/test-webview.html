<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebView é€šè®¯æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.success { color: #28a745; }
        .log-entry.error { color: #dc3545; }
        .log-entry.info { color: #17a2b8; }
        .log-entry.warn { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”— WebView é€šè®¯æµ‹è¯•</h1>
            <p>æµ‹è¯• Vue åº”ç”¨ä¸å¾®ä¿¡å°ç¨‹åºä¹‹é—´çš„ postMessage é€šè®¯</p>
        </div>

        <div class="status" id="status">
            <strong>ç¯å¢ƒçŠ¶æ€:</strong> <span id="env-status">æ£€æµ‹ä¸­...</span>
        </div>

        <div>
            <h3>ğŸ“¤ å‘é€æ¶ˆæ¯åˆ°å°ç¨‹åº</h3>
            <button class="button" onclick="testGetMallToken()">è·å– mall_token</button>
            <button class="button" onclick="testLogin()">å¾®ä¿¡ç™»å½•</button>
            <button class="button" onclick="testGetUserInfo()">è·å–ç”¨æˆ·ä¿¡æ¯</button>
            <button class="button" onclick="testGetLocation()">è·å–ä½ç½®</button>
            <button class="button" onclick="testShowToast()">æ˜¾ç¤º Toast</button>
            <button class="button" onclick="testShowModal()">æ˜¾ç¤º Modal</button>
            <button class="button" onclick="testShare()">æµ‹è¯•åˆ†äº«</button>
            <button class="button" onclick="testPayment()">æµ‹è¯•æ”¯ä»˜</button>
        </div>

        <div style="margin-top: 20px;">
            <h3>ğŸ“¥ è‡ªå®šä¹‰æ¶ˆæ¯</h3>
            <input type="text" id="customType" placeholder="æ¶ˆæ¯ç±»å‹" style="padding: 8px; margin: 5px; width: 150px;">
            <input type="text" id="customData" placeholder="æ¶ˆæ¯æ•°æ® (JSON)" style="padding: 8px; margin: 5px; width: 300px;">
            <button class="button" onclick="sendCustomMessage()">å‘é€</button>
        </div>

        <div style="margin-top: 20px;">
            <h3>ğŸ“Š æ¶ˆæ¯æ—¥å¿—</h3>
            <button class="button" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let isInMiniProgram = false;
        let messageQueue = [];
        let messageId = 0;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ£€æµ‹ç¯å¢ƒ
        function detectEnvironment() {
            if (typeof window !== 'undefined' && window.wx && window.wx.miniProgram) {
                window.wx.miniProgram.getEnv((res) => {
                    isInMiniProgram = res.miniprogram;
                    document.getElementById('env-status').textContent =
                        isInMiniProgram ? 'âœ… å¾®ä¿¡å°ç¨‹åº WebView' : 'âŒ æ™®é€šæµè§ˆå™¨';

                    if (isInMiniProgram) {
                        log('âœ… æ£€æµ‹åˆ°å¾®ä¿¡å°ç¨‹åº WebView ç¯å¢ƒ', 'success');
                        setupMessageListener();
                    } else {
                        log('âš ï¸ ä¸åœ¨å¾®ä¿¡å°ç¨‹åºç¯å¢ƒä¸­ï¼ŒæŸäº›åŠŸèƒ½æ— æ³•æµ‹è¯•', 'warn');
                        simulateMiniProgram();
                    }
                });
            } else {
                log('âŒ æœªæ£€æµ‹åˆ°å¾®ä¿¡å°ç¨‹åº SDKï¼Œå¯ç”¨æ¨¡æ‹Ÿæ¨¡å¼', 'warn');
                document.getElementById('env-status').textContent = 'âš ï¸ æ¨¡æ‹Ÿæ¨¡å¼';
                simulateMiniProgram();
            }
        }

        // è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨
        function setupMessageListener() {
            // ç›‘å¬æ¥è‡ªå°ç¨‹åºçš„æ¶ˆæ¯
            window.addEventListener('message', (event) => {
                log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(event.data)}`, 'info');
                handleMessage(event.data);
            });
        }

        // å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯
        function handleMessage(message) {
            if (!message || typeof message !== 'object') {
                return;
            }

            // å¤„ç†å“åº”æ¶ˆæ¯
            if (message.msgId) {
                const pendingMessage = messageQueue.find(m => m.id === message.msgId);
                if (pendingMessage) {
                    clearTimeout(pendingMessage.timeout);
                    messageQueue = messageQueue.filter(m => m.id !== message.msgId);

                    if (message.success) {
                        pendingMessage.resolve(message.data);
                        log(`âœ… æ”¶åˆ°å“åº” [${message.msgId}]: ${JSON.stringify(message.data)}`, 'success');
                    } else {
                        pendingMessage.reject(new Error(message.errMsg || 'æ“ä½œå¤±è´¥'));
                        log(`âŒ æ”¶åˆ°é”™è¯¯å“åº” [${message.msgId}]: ${message.errMsg}`, 'error');
                    }
                }
                return;
            }

            // å¤„ç†ä¸»åŠ¨æ¶ˆæ¯
            if (message.type) {
                log(`ğŸ“¥ æ”¶åˆ°ä¸»åŠ¨æ¶ˆæ¯ [${message.type}]: ${JSON.stringify(message.data)}`, 'info');
            }
        }

        // å‘é€æ¶ˆæ¯åˆ°å°ç¨‹åº
        function sendMessage(type, data) {
            return new Promise((resolve, reject) => {
                if (!isInMiniProgram) {
                    reject(new Error('ä¸åœ¨å¾®ä¿¡å°ç¨‹åºç¯å¢ƒä¸­'));
                    return;
                }

                const msgId = `test_${++messageId}`;
                const message = {
                    type,
                    data,
                    id: msgId,
                    timestamp: Date.now()
                };

                // è®¾ç½®è¶…æ—¶
                const timeout = setTimeout(() => {
                    messageQueue = messageQueue.filter(m => m.id !== msgId);
                    reject(new Error('æ¶ˆæ¯å‘é€è¶…æ—¶'));
                }, 10000);

                messageQueue.push({
                    id: msgId,
                    resolve,
                    reject,
                    timeout
                });

                try {
                    log(`ğŸ“¤ å‘é€æ¶ˆæ¯ [${type}]: ${JSON.stringify(data)}`, 'info');
                    window.wx.miniProgram.postMessage(message);
                } catch (error) {
                    clearTimeout(timeout);
                    messageQueue = messageQueue.filter(m => m.id !== msgId);
                    reject(error);
                    log(`âŒ å‘é€æ¶ˆæ¯å¤±è´¥: ${error.message}`, 'error');
                }
            });
        }

        // æµ‹è¯•å‡½æ•°
        async function testGetMallToken() {
            try {
                log('ğŸ” æµ‹è¯•è·å– mall_token...', 'info');
                const result = await sendMessage('getMallToken');
                log(`âœ… mall_token è·å–æˆåŠŸ: ${JSON.stringify(result)}`, 'success');
            } catch (error) {
                log(`âŒ mall_token è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            try {
                log('ğŸ”‘ æµ‹è¯•å¾®ä¿¡ç™»å½•...', 'info');
                const result = await sendMessage('login');
                log(`âœ… ç™»å½•æˆåŠŸ: ${JSON.stringify(result)}`, 'success');
            } catch (error) {
                log(`âŒ ç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testGetUserInfo() {
            try {
                log('ğŸ‘¤ æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯...', 'info');
                const result = await sendMessage('getUserInfo');
                log(`âœ… ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ: ${JSON.stringify(result)}`, 'success');
            } catch (error) {
                log(`âŒ ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testGetLocation() {
            try {
                log('ğŸ“ æµ‹è¯•è·å–ä½ç½®...', 'info');
                const result = await sendMessage('getLocation');
                log(`âœ… ä½ç½®è·å–æˆåŠŸ: ${JSON.stringify(result)}`, 'success');
            } catch (error) {
                log(`âŒ ä½ç½®è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testShowToast() {
            try {
                log('ğŸ æµ‹è¯•æ˜¾ç¤º Toast...', 'info');
                await sendMessage('showToast', { title: 'æµ‹è¯•æ¶ˆæ¯', icon: 'success', duration: 2000 });
                log('âœ… Toast æ˜¾ç¤ºæˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ Toast æ˜¾ç¤ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testShowModal() {
            try {
                log('ğŸ’¬ æµ‹è¯•æ˜¾ç¤º Modal...', 'info');
                const result = await sendMessage('showModal', {
                    title: 'æµ‹è¯•å¯¹è¯æ¡†',
                    content: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¯¹è¯æ¡†',
                    showCancel: true,
                    confirmText: 'ç¡®å®š',
                    cancelText: 'å–æ¶ˆ'
                });
                log(`âœ… Modal æ˜¾ç¤ºæˆåŠŸï¼Œç”¨æˆ·é€‰æ‹©: ${result.confirm ? 'ç¡®å®š' : 'å–æ¶ˆ'}`, 'success');
            } catch (error) {
                log(`âŒ Modal æ˜¾ç¤ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testShare() {
            try {
                log('ğŸ“¤ æµ‹è¯•åˆ†äº«...', 'info');
                await sendMessage('share', {
                    title: 'æ»¨æ±Ÿå®å²¸å•†åœº',
                    desc: 'ä¼˜æƒ è´­ç‰©ï¼Œå“è´¨ç”Ÿæ´»',
                    path: '/pages/webview/webview',
                    imageUrl: '/assets/images/share-logo.png'
                });
                log('âœ… åˆ†äº«è®¾ç½®æˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ åˆ†äº«è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testPayment() {
            try {
                log('ğŸ’° æµ‹è¯•æ”¯ä»˜...', 'info');
                await sendMessage('payment', {
                    orderId: 'TEST_' + Date.now(),
                    amount: 0.01,
                    description: 'æµ‹è¯•æ”¯ä»˜'
                });
                log('âœ… æ”¯ä»˜è¯·æ±‚å‘é€æˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ æ”¯ä»˜è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function sendCustomMessage() {
            const type = document.getElementById('customType').value.trim();
            const dataStr = document.getElementById('customData').value.trim();

            if (!type) {
                log('âŒ è¯·è¾“å…¥æ¶ˆæ¯ç±»å‹', 'error');
                return;
            }

            let data;
            if (dataStr) {
                try {
                    data = JSON.parse(dataStr);
                } catch (error) {
                    log(`âŒ JSON æ ¼å¼é”™è¯¯: ${error.message}`, 'error');
                    return;
                }
            } else {
                data = {};
            }

            try {
                log(`ğŸ“¤ å‘é€è‡ªå®šä¹‰æ¶ˆæ¯ [${type}]...`, 'info');
                const result = await sendMessage(type, data);
                log(`âœ… è‡ªå®šä¹‰æ¶ˆæ¯å‘é€æˆåŠŸ: ${JSON.stringify(result)}`, 'success');
            } catch (error) {
                log(`âŒ è‡ªå®šä¹‰æ¶ˆæ¯å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('ğŸ§¹ æ—¥å¿—å·²æ¸…é™¤', 'info');
        }

        // æ¨¡æ‹Ÿå°ç¨‹åºç¯å¢ƒï¼ˆç”¨äºæµ‹è¯•ï¼‰
        function simulateMiniProgram() {
            // æ¨¡æ‹Ÿ wx å¯¹è±¡
            window.wx = {
                miniProgram: {
                    postMessage: function(message) {
                        log(`ğŸ“¤ [æ¨¡æ‹Ÿ] å‘é€æ¶ˆæ¯åˆ°å°ç¨‹åº: ${JSON.stringify(message)}`, 'info');

                        // æ¨¡æ‹Ÿå“åº”
                        setTimeout(() => {
                            const responses = {
                                'getMallToken': {
                                    success: true,
                                    msgId: message.id,
                                    data: {
                                        token: 'mock_mall_token_' + Date.now(),
                                        user: {
                                            id: 12345,
                                            nickname: 'æµ‹è¯•ç”¨æˆ·',
                                            phone: '138****8888'
                                        }
                                    }
                                },
                                'login': {
                                    success: true,
                                    msgId: message.id,
                                    userInfo: {
                                        id: 12345,
                                        nickname: 'æµ‹è¯•ç”¨æˆ·',
                                        phone: '138****8888'
                                    }
                                },
                                'getUserInfo': {
                                    success: true,
                                    msgId: message.id,
                                    userInfo: {
                                        id: 12345,
                                        nickname: 'æµ‹è¯•ç”¨æˆ·',
                                        phone: '138****8888',
                                        avatar: '/assets/images/avatar.png'
                                    }
                                },
                                'getLocation': {
                                    success: true,
                                    msgId: message.id,
                                    latitude: 23.123456,
                                    longitude: 113.123456,
                                    address: 'å¹¿å·å¸‚å¤©æ²³åŒº'
                                },
                                'showToast': {
                                    success: true,
                                    msgId: message.id
                                },
                                'showModal': {
                                    success: true,
                                    msgId: message.id,
                                    confirm: true
                                },
                                'share': {
                                    success: true,
                                    msgId: message.id,
                                    setupComplete: true
                                },
                                'payment': {
                                    success: true,
                                    msgId: message.id,
                                    orderId: message.data.orderId
                                }
                            };

                            const response = responses[message.type] || {
                                success: false,
                                msgId: message.id,
                                errMsg: `ä¸æ”¯æŒçš„æ¶ˆæ¯ç±»å‹: ${message.type}`
                            };

                            // è§¦å‘æ¶ˆæ¯äº‹ä»¶
                            const event = new MessageEvent('message', {
                                data: response
                            });
                            window.dispatchEvent(event);
                        }, 500 + Math.random() * 1000);
                    },
                    getEnv: function(callback) {
                        setTimeout(() => callback({ miniprogram: true }), 100);
                    }
                }
            };

            isInMiniProgram = true;
            document.getElementById('env-status').textContent = 'ğŸ­ æ¨¡æ‹Ÿå°ç¨‹åºç¯å¢ƒ';
            log('ğŸ­ å·²å¯ç”¨æ¨¡æ‹Ÿå°ç¨‹åºç¯å¢ƒ', 'success');
            setupMessageListener();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            log('ğŸš€ WebView æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            detectEnvironment();
        };

        // ç›‘å¬ URL å‚æ•°å˜åŒ–
        window.addEventListener('popstate', function() {
            const params = new URLSearchParams(window.location.search);
            const mallToken = params.get('mall_token');
            if (mallToken) {
                log(`ğŸ” ä» URL å‚æ•°æ£€æµ‹åˆ° mall_token: ${mallToken.substring(0, 20)}...`, 'success');
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ URL å‚æ•°
        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            const mallToken = params.get('mall_token');
            if (mallToken) {
                log(`ğŸ” ä» URL å‚æ•°æ£€æµ‹åˆ° mall_token: ${mallToken.substring(0, 20)}...`, 'success');
            }
        });
    </script>
</body>
</html>