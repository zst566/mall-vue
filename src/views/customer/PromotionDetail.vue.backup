<template>
  <div class="promotion-detail-page">
    <!-- å¯¼èˆªæ  -->
    <van-nav-bar
      :title="promotion?.value?.name || 'ä¿ƒé”€æ´»åŠ¨è¯¦æƒ…'"
      left-arrow
      @click-left="onClickLeft"
      fixed
      placeholder
      z-index="100"
      class="detail-nav-bar"
    />

    <!-- Banner ä¸»å›¾ -->
    <PromotionBanner :images="imagesRef" />

    <!-- ä¿ƒé”€æ´»åŠ¨åŸºæœ¬ä¿¡æ¯ -->
    <!-- è°ƒè¯•ï¼šæ£€æŸ¥æ¡ä»¶åˆ¤æ–­ - ä¿®å¤è¯­æ³•é”™è¯¯ -->
    <div style="background: #fff3cd; padding: 12px; margin: 16px; border: 2px solid #ffc107; font-family: monospace; font-size: 12px;">
      <div style="font-weight: bold; color: #856404; margin-bottom: 8px;">
        ğŸ” [PromotionDetail] è°ƒè¯•ä¿¡æ¯ ({{ new Date().toLocaleTimeString() }}):
      </div>
      <div>promotion ref å­˜åœ¨: {{ !!promotion }}</div>
      <div :style="{ fontWeight: 'bold', color: !!promotion?.value ? 'green' : 'red' }">
        promotion.value å­˜åœ¨: {{ !!promotion?.value }}
      </div>
      <div>promotion.value?.id: {{ promotion?.value?.id }}</div>
      <div>promotion.value?.name: {{ promotion?.value?.name }}</div>
      <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ffc107;">
        <div style="font-weight: bold; margin-bottom: 4px;">shop æ•°æ®è¯¦æƒ…:</div>
        <div>hasShop: {{ !!promotion?.value?.shop }}</div>
        <div>shopCode: {{ promotion?.value?.shop?.shopCode }}</div>
        <div>floor: {{ promotion?.value?.shop?.floor }}</div>
        <div>tenantName: {{ promotion?.value?.shop?.tenantName }}</div>
        <div :style="{
          color: (promotion?.value?.shop && (promotion?.value?.shop?.shopCode || promotion?.value?.shop?.floor)) ? 'green' : 'red',
          fontWeight: 'bold',
          marginTop: '8px'
        }">
          â­ v-if æ¡ä»¶ç»“æœ (åº”è¯¥æ˜¾ç¤ºå•†é“ºä¿¡æ¯): {{ !!(promotion?.value?.shop && (promotion?.value?.shop?.shopCode || promotion?.value?.shop?.floor)) }}
        </div>
      </div>
    </div>
    <PromotionInfo
      v-if="promotion?.value"
      :promotion="promotion.value"
      :selected-variant="selectedVariant"
      :variants="variants"
      :tags="tags"
      :is-activity-active="isActivityActiveValue"
      :left-quantity="leftQuantity"
      :is-mall-subsidy="isMallSubsidy"
      :final-amount="finalAmount"
      :sale-price="salePrice"
      :original-price="originalPrice"
      :format-price="formatPrice"
      @update:selected-variant="selectedVariant = $event"
      @tag-click="handleTagClick"
    />

    <!-- è¯¦æƒ…å›¾ç‰‡ -->
    <PromotionDetailImages :images="detailImages" />

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <PromotionBottomBar
      :is-favorite="isFavorite"
      :can-purchase="canPurchase"
      :purchase-button-text="purchaseButtonText"
      :is-visible="isBottomBarVisible"
      :bottom-bar-style="bottomBarStyle"
      @home="goToHome"
      @favorite="toggleFavorite"
      @service="contactService"
      @purchase="handlePurchase"
    />
  </div>
</template>

<script setup lang="ts">
import { computed, onMounted, onUnmounted, watch } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { showToast } from 'vant'
import PromotionBanner from '@/components/customer/PromotionBanner.vue'
import PromotionInfo from '@/components/customer/PromotionInfo.vue'
import PromotionDetailImages from '@/components/customer/PromotionDetailImages.vue'
import PromotionBottomBar from '@/components/customer/PromotionBottomBar.vue'
import { usePromotionDetail } from '@/composables/usePromotionDetail'
import { usePromotionPurchase } from '@/composables/usePromotionPurchase'
import { usePromotionFavorite } from '@/composables/usePromotionFavorite'
import { usePromotionImages } from '@/composables/usePromotionImages'
import { usePromotionPrice } from '@/composables/usePromotionPrice'
import { usePromotionTags } from '@/composables/usePromotionTags'
import { useBottomBarScroll } from '@/composables/useBottomBarScroll'
import { isActivityActive } from '@/utils/promotionHelpers'
import webViewBridge from '@/utils/webview-bridge'

const router = useRouter()
const route = useRoute()
const promotionId = route.params.id as string

// æ•°æ®åŠ è½½
const {
  promotion,
  loading,
  variants,
  selectedVariant,
  tags,
  loadPromotionDetail
} = usePromotionDetail(promotionId)

// è°ƒè¯•ï¼šæ£€æŸ¥ promotion çš„ç±»å‹å’Œå€¼
console.log('ğŸ” [PromotionDetail.vue] promotion åˆå§‹åŒ–:', {
  'promotion ç±»å‹': typeof promotion,
  'æ˜¯å¦ä¸º ref': promotion && typeof promotion === 'object' && 'value' in promotion,
  'promotion.value åˆå§‹å€¼': promotion?.value,
  'promotion å¯¹è±¡': promotion,
})

// ç›‘å¬ promotion.value çš„å˜åŒ–
watch(() => promotion?.value, (newValue, oldValue) => {
  console.log('ğŸ” [PromotionDetail.vue] promotion.value å˜åŒ–:', JSON.stringify({
    'oldValue': oldValue,
    'newValueå­˜åœ¨': !!newValue,
    'newValue.id': newValue?.id,
    'newValue.name': newValue?.name,
    'newValue.shopå­˜åœ¨': !!newValue?.shop,
    'newValue.shopCode': newValue?.shop?.shopCode,
    'newValue.floor': newValue?.shop?.floor,
  }, null, 2))
  
  // æ£€æŸ¥æ¨¡æ¿ä¸­çš„ promotion å¼•ç”¨
  console.log('ğŸ” [PromotionDetail.vue] æ£€æŸ¥ promotion å¼•ç”¨:', {
    'promotion æ˜¯å¦ä¸º ref': promotion && typeof promotion === 'object' && 'value' in promotion,
    'promotion.value å½“å‰å€¼': promotion?.value,
    'promotion.value ç±»å‹': typeof promotion?.value,
    'promotion.value === null': promotion?.value === null,
    'promotion.value === undefined': promotion?.value === undefined,
  })
}, { immediate: true, deep: true })

// å›¾ç‰‡å¤„ç† - ç›´æ¥ä½¿ç”¨ promotion.value.images ç¡®ä¿å“åº”å¼æ›´æ–°
const imagesRef = computed(() => promotion?.value?.images)
const { mainImages, detailImages } = usePromotionImages(imagesRef)

// ä»·æ ¼è®¡ç®—
const { isMallSubsidy, finalAmount, salePrice, originalPrice, leftQuantity, formatPrice } = usePromotionPrice({
  promotion,
  selectedVariant,
})

// æ ‡ç­¾ç®¡ç†
const tagsRef = computed(() => tags.value)
const { showTagDescription, handleDocumentClick } = usePromotionTags(tagsRef)

// æ”¶è—ç®¡ç†
const { isFavorite, toggleFavorite, initFavoriteStatus } = usePromotionFavorite(promotionId)

// è´­ä¹°é€»è¾‘
const leftQuantityRef = computed(() => leftQuantity.value)
const { canPurchase, purchaseButtonText, handlePurchase } = usePromotionPurchase({
  promotionId,
  promotion,
  selectedVariant,
  variants,
  leftQuantity: leftQuantityRef,
})

// åº•éƒ¨æ æ»šåŠ¨æ§åˆ¶
const { isBottomBarVisible, bottomBarStyle } = useBottomBarScroll()

// æ´»åŠ¨çŠ¶æ€
const isActivityActiveValue = computed(() => {
  if (!promotion?.value) {
    console.log('âš ï¸ isActivityActiveValue: promotion.value ä¸ºç©º')
    return false
  }
  const result = isActivityActive(promotion.value.startTime, promotion.value.endTime)
  console.log('âœ… isActivityActiveValue:', result, {
    startTime: promotion.value.startTime,
    endTime: promotion.value.endTime,
  })
  return result
})

// è°ƒè¯•ï¼šæ£€æŸ¥ promotion çŠ¶æ€
const promotionDebug = computed(() => {
  console.log('ğŸ” promotion è°ƒè¯•ä¿¡æ¯:', {
    hasPromotion: !!promotion,
    hasValue: !!promotion?.value,
    valueId: promotion?.value?.id,
    valueName: promotion?.value?.name,
  })
  return promotion?.value
})

// æ ‡ç­¾ç‚¹å‡»å¤„ç†
const handleTagClick = (tagId: string) => {
  showTagDescription(tagId)
}

// æ”¯ä»˜ç»“æœå¤„ç†
const handlePaymentResult = (result: any) => {
  if (result?.success) {
    loadPromotionDetail()
    showToast('æ”¯ä»˜æˆåŠŸï¼')
  }
}

// é¡µé¢æ¿€æ´»åˆ·æ–°
let lastRefreshTime = 0
const REFRESH_INTERVAL = 2000 // 2ç§’å†…ä¸é‡å¤åˆ·æ–°
const handlePageActivated = () => {
  const now = Date.now()
  // é¿å…è¿‡äºé¢‘ç¹çš„åˆ·æ–°
  if (now - lastRefreshTime < REFRESH_INTERVAL) {
    console.log('é¡µé¢æ¿€æ´»åˆ·æ–°è¢«èŠ‚æµï¼Œè·³è¿‡')
    return
  }
  lastRefreshTime = now
  console.log('é¡µé¢æ¿€æ´»ï¼Œåˆ·æ–°ä¿ƒé”€è¯¦æƒ…æ•°æ®')
  loadPromotionDetail()
}

// é¡µé¢æ¿€æ´»äº‹ä»¶å¤„ç†å™¨
let handleVisibilityChange: (() => void) | null = null
let handlePageShow: ((event: PageTransitionEvent) => void) | null = null

// è¿”å›é¦–é¡µ
const goToHome = () => {
  router.push({ name: 'Home' })
}

// è¿”å›ä¸Šä¸€é¡µ
const onClickLeft = () => {
  router.back()
}

// è”ç³»å®¢æœ
const contactService = () => {
  showToast('æ­£åœ¨è·³è½¬åˆ°å®¢æœèŠå¤©...')
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  loadPromotionDetail()
  
  // ç›‘å¬æ”¯ä»˜ç»“æœæ¶ˆæ¯
  webViewBridge.on('paymentResult', handlePaymentResult)
  
  // ç›‘å¬é¡µé¢ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»å¤–éƒ¨æ—¶å…³é—­æç¤ºæ¡†
  document.addEventListener('click', handleDocumentClick, true)
  
  // ç›‘å¬é¡µé¢æ¿€æ´»äº‹ä»¶ï¼ˆä»å…¶ä»–é¡µé¢è¿”å›æ—¶ï¼‰
  // ä½¿ç”¨ visibilitychange äº‹ä»¶æ£€æµ‹é¡µé¢æ˜¯å¦å¯è§
  handleVisibilityChange = () => {
    if (!document.hidden) {
      // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œåˆ·æ–°æ•°æ®
      handlePageActivated()
    }
  }
  document.addEventListener('visibilitychange', handleVisibilityChange)
  
  // ä½¿ç”¨ pageshow äº‹ä»¶æ£€æµ‹é¡µé¢æ˜¾ç¤ºï¼ˆåŒ…æ‹¬ä»ç¼“å­˜æ¢å¤ï¼‰
  handlePageShow = (event: PageTransitionEvent) => {
    // å¦‚æœæ˜¯ä»ç¼“å­˜æ¢å¤çš„é¡µé¢ï¼Œåˆ·æ–°æ•°æ®
    if (event.persisted) {
      handlePageActivated()
    }
  }
  window.addEventListener('pageshow', handlePageShow)
})

onUnmounted(() => {
  // ç§»é™¤æ”¯ä»˜ç»“æœç›‘å¬
  webViewBridge.off('paymentResult', handlePaymentResult)
  
  // ç§»é™¤é¡µé¢ç‚¹å‡»ç›‘å¬
  document.removeEventListener('click', handleDocumentClick, true)
  
  // ç§»é™¤é¡µé¢æ¿€æ´»ç›‘å¬
  if (handleVisibilityChange) {
    document.removeEventListener('visibilitychange', handleVisibilityChange)
  }
  if (handlePageShow) {
    window.removeEventListener('pageshow', handlePageShow)
  }
})
</script>

<style lang="scss" scoped>
@use '@/styles/variables.scss' as *;
@use '@/styles/mixins.scss' as *;

.promotion-detail-page {
  min-height: 100vh;
  padding-bottom: 80px; // ä¸ºåº•éƒ¨æ“ä½œæ ç•™å‡ºç©ºé—´
  background: var(--theme-bg-gradient, $glass-bg-gradient);
  background-attachment: fixed;
  background-size: cover;

  // å¯¼èˆªæ æ ·å¼ - é€æ˜èƒŒæ™¯ä¸ banner èåˆ
  :deep(.detail-nav-bar) {
    background: transparent;
    
    .van-nav-bar__content {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .van-nav-bar__title {
      color: white;
      font-weight: 600;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
    
    .van-nav-bar__arrow {
      color: white;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
  }
}
</style>
