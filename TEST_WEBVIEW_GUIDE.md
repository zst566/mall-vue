# WebView 通讯测试指南

## 🚀 快速开始

### 1. 访问测试页面

**Vue 应用测试页面：**
```
http://localhost:3003/webview-test
```

**独立测试页面（模拟环境）：**
```
http://localhost:3003/test-webview.html
```

### 2. 测试环境说明

#### 环境 1: 普通浏览器测试
- 访问 `http://localhost:3003/test-webview.html`
- 自动启用模拟模式
- 可以测试所有消息类型，但响应是模拟数据

#### 环境 2: 微信小程序 WebView 测试
- 在微信开发者工具中打开小程序项目
- 配置 WebView URL 指向 `http://localhost:3003/webview-test`
- 真实的 postMessage 通讯测试

## 📋 测试步骤

### 步骤 1: 环境检测

1. **打开测试页面**
2. **查看环境状态**
   - ✅ 微信小程序 WebView: 真实环境
   - 🎭 模拟小程序环境: 浏览器模拟
   - ❌ 普通浏览器: 部分功能不可用

### 步骤 2: 基础通讯测试

#### 测试获取 mall_token
```
点击 "获取 mall_token" 按钮
预期结果: 收到包含 token 和用户信息的响应
```

#### 测试微信登录
```
点击 "微信登录" 按钮
预期结果: 收到登录成功的响应
```

#### 测试获取用户信息
```
点击 "获取用户信息" 按钮
预期结果: 收到用户详细信息
```

### 步骤 3: 功能测试

#### Toast 测试
```
点击 "显示 Toast" 按钮
预期结果: 小程序显示 Toast 消息
```

#### Modal 测试
```
点击 "显示 Modal" 按钮
预期结果: 小程序显示对话框，选择后返回结果
```

#### 位置测试
```
点击 "获取位置" 按钮
预期结果: 收到位置信息（需要用户授权）
```

#### 分享测试
```
点击 "测试分享" 按钮
预期结果: 小程序显示分享菜单
```

#### 支付测试
```
点击 "测试支付" 按钮
预期结果: 小程序显示支付界面（测试金额）
```

### 步骤 4: 自定义消息测试

1. **输入消息类型**: 例如 `customTest`
2. **输入消息数据**: 例如 `{"test": "data"}`
3. **点击发送**
4. **查看响应**

## 🔧 微信小程序端配置

### 1. 配置业务域名

在微信开发者工具中：
1. 打开小程序项目 (`mall-miniprogram`)
2. 点击 "详情" → "本地设置"
3. 勾选 "不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

### 2. 修改 WebView URL

编辑 `pages/webview/webview.js`:

```javascript
// 修改 buildWebViewURL 方法
async buildWebViewURL() {
  // 使用本地开发服务器
  const baseUrl = 'http://localhost:3003/webview-test';

  // 添加 mall_token 参数（如果存在）
  const token = await authManager.getAccessToken();
  if (token) {
    return `${baseUrl}?mall_token=${encodeURIComponent(token)}`;
  }

  return baseUrl;
}
```

### 3. 配置业务域名白名单

在 `pages/webview/webview.js` 中添加本地域名：

```javascript
allowedDomains: [
  'wepark-a.gdtvdv.com',
  'localhost',
  '127.0.0.1',
  '192.168.31.89',  // 你的本地 IP
  '192.168.31.223'  // 其他本地 IP
]
```

## 📱 实际测试流程

### 完整的端到端测试

#### 1. 启动开发服务器
```bash
cd mall-vue
npm run dev
# 服务运行在 http://localhost:3003
```

#### 2. 启动小程序开发工具
```bash
cd mall-miniprogram
npm run dev:weapp  # 或在微信开发者工具中打开
```

#### 3. 配置小程序 WebView
1. 在小程序开发工具中导航到 WebView 页面
2. WebView 应该自动加载 Vue 应用测试页面

#### 4. 执行测试序列

**测试序列 1: Token 获取流程**
```
1. 清除小程序的登录状态
2. 点击 "获取 mall_token"
3. 观察小程序是否自动执行登录流程
4. 验证 Vue 应用是否收到正确的 token
```

**测试序列 2: 双向通讯**
```
1. 在 Vue 端点击 "获取用户信息"
2. 在小程序端观察日志输出
3. 在 Vue 端验证响应数据
4. 在小程序端发送主动消息（如订阅消息）
5. 在 Vue 端验证是否收到
```

**测试序列 3: 错误处理**
```
1. 模拟网络断开
2. 尝试发送消息
3. 验证超时处理
4. 模拟无效消息格式
5. 验证错误处理
```

## 🐛 常见问题排查

### 问题 1: 环境检测失败
**症状**: 页面显示不在微信小程序环境中
**解决方案**:
1. 确保在微信开发者工具的 WebView 中打开
2. 检查小程序是否正确配置了业务域名
3. 使用 `test-webview.html` 进行模拟测试

### 问题 2: 消息发送失败
**症状**: 点击按钮没有响应或显示错误
**解决方案**:
1. 检查 `bindmessage` 事件是否正确绑定
2. 查看小程序开发工具的控制台错误
3. 验证消息格式是否符合规范

### 问题 3: Token 获取失败
**症状**: 获取 mall_token 返回错误
**解决方案**:
1. 检查小程序登录状态
2. 验证后端 API 是否正常
3. 查看 `authManager` 的状态

### 问题 4: 网络连接问题
**症状**: 无法连接到 Vue 开发服务器
**解决方案**:
1. 确保开发服务器正在运行
2. 检查防火墙设置
3. 使用 IP 地址而非 localhost

## 📊 测试结果记录

### 成功测试的标志

#### Vue 端
- ✅ 页面显示 "微信小程序 WebView" 环境
- ✅ 所有按钮可以正常点击
- ✅ 控制台显示详细的调试日志
- ✅ 收到小程序的正确响应

#### 小程序端
- ✅ WebView 正确加载 Vue 页面
- ✅ 控制台显示收到来自 Vue 的消息
- ✅ 正确处理并发送响应消息
- ✅ 桥接功能正常工作

### 测试报告模板

```
## WebView 通讯测试报告

**测试日期**: 2024-XX-XX
**测试环境**: 微信开发者工具 + 本地开发服务器

### 基础功能测试
- [ ] 环境检测
- [ ] Token 获取
- [ ] 用户登录
- [ ] 用户信息获取

### 交互功能测试
- [ ] Toast 显示
- [ ] Modal 对话框
- [ ] 位置获取
- [ ] 分享功能
- [ ] 支付功能

### 通讯质量测试
- [ ] 消息发送成功率
- [ ] 响应时间
- [ ] 错误处理
- [ ] 超时处理

### 发现的问题
1. [问题描述]
2. [问题描述]

### 解决方案
1. [解决方案]
2. [解决方案]

**测试结论**: 通过/不通过
**测试人**: [姓名]
```

## 🎯 进阶测试

### 性能测试
1. **消息频率测试**: 快速连续发送消息
2. **大数据量测试**: 发送较大的数据包
3. **内存泄漏测试**: 长时间运行的稳定性

### 压力测试
1. **并发连接**: 多个 WebView 同时连接
2. **网络异常**: 模拟网络中断和恢复
3. **边界条件**: 测试各种极端情况

### 兼容性测试
1. **不同版本微信**: 测试不同版本的微信客户端
2. **不同设备**: 测试不同手机型号
3. **网络环境**: WiFi vs 4G/5G 网络

通过这些测试，你可以全面验证 WebView 通讯功能的正确性和稳定性。